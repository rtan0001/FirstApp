# AWS CloudFormation deployment

## Overview

The infrastructure for the UGM application is managed by CloudFormation.

The templates for each of the different components managed via CloudFormation deployed with `mondo` (https://bitbucket.apps.monash.edu:8443/projects/APPDEV/repos/mondo/browse)

## Local development setup

Ensure you have `mondo` installed.  (see https://bitbucket.apps.monash.edu:8443/projects/APPDEV/repos/mondo/browse)

## Overview of CloudFormation templates

There are 3 different CloudFormation templates, each required for a different purpose.

A summary of each template is as follows:

* `application` is the main Application template, it contains the assets that make up the running application, sync server (between callista and the app db), and the application database.
* `deploy_role` is the definition of the permissions required to deploy the `application` stack.  The `deploy_role` is required in any of the AWS accounts that will need to host the `application` stack
* `waf` is the template to manage the public access through CloudFront and the Monash WAF

## Development approach

The ability to develop and modify the application infrastructure is a key deliverable in the UGM project.

With the code and scripts in this repository it should be possible to create nearly all of the moving parts that make up the UGM application.  Due to the setup and configuration of the Monash AWS environment, there are a number of parts that still require manual configuration.

For all other 'AWS native' components the development workflow is as easy as:

* Create your own UGM application stack for testing using:
    `mondo deploy --name <stack_name> --create --template application.yaml --scope application --config ../config/<stack_name>.json`

* Modify the Cloudformation template `application.yaml` to modify current resources or create new resources

* To validate the template is correctly written run the following from the `ops/cloudformation` directory
    `aws cloudformation validate-template --template-body file://application.yaml`

* You can run a dry run which produces a list of the changes without updating your stack by running the following command.
    `mondo deploy --name <stack_name> --create --template application.yaml --scope application --config ../config/<config_file>.json --version <version_number> --dry_run`

* Finally update your test stack using:
    `mondo deploy --name <stack_name> --template application.yaml --scope application  --config ../config/<config_file>.json`

* If the stack update is complete, and you are happy with your changes. Follow the standard development workflow of:
    * Create a branch for your changes, including the UGM-??? story number
    * Push your changes to the branch with good commit messages
    * Create a pull-request for your changes
    * Move the card to the 'Review' column

* Once the pull-request has been reviewed and approved, you can merge your changes and ensure that it deploys through into the POC/DEV environments as expected.

## Things NOT under code control

* Monash domain names ending in `apps.monash.edu`
    * These are managed in the [AddHost](https://webnet.its.monash.edu.au/cgi-bin/addhost/index.html) application, managed by Monash IS staff members.
* SSL certificates for any non AWS Monash domains, eg `apps.monash.edu`
    * These are generated by request through the Monash IS team members.

### Configuration

To ensure environment isolation, the CloudFormation template has parameters that enable the same template to be deployed across multiple environments.  To enable this isolation, CloudFormation parameters are used to supply the variance between environments.

The parameters can be supplied in 2 different ways:
* Loaded from a JSON file via the `config_filename` parameters
* Supplied as `add_parameters` options at deployment time

### HOWTO: Creating a new environment stack

The default behaviour of the `deploy` scripts are to update existing CloudFormation stacks, so to create the initial Stack you must supply the `--create` flag.
